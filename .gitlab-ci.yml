image: mcr.microsoft.com/dotnet/sdk:latest
stages:
- build
- test
- release

variables:
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1
  DOTNET_NOLOGO: 1

before_script:
  - wget https://packages.microsoft.com/config/debian/11/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
  - dpkg -i packages-microsoft-prod.deb
  - rm packages-microsoft-prod.deb
  - apt-get update
  - apt-get install -y dotnet-runtime-6.0 dotnet-runtime-3.1

build-release:
  stage: build
  script:
    - ./release.sh
  artifacts:
    paths:
      - '**/*.nupkg'
      - '**/*.snupkg'
  only:
    - master

build-prerelease:
  stage: build
  script:
    - ./release.sh "develop$CI_PIPELINE_ID"
  artifacts:
    paths:
      - '**/*.nupkg'
      - '**/*.snupkg'
  except:
    - master

unittest:
  stage: test
  script:
    - ./unittest.sh

publish:
  stage: release
  script:
    - ./publish.sh "$NUGET_GL_L4N"
  only:
    - master
    - develop
